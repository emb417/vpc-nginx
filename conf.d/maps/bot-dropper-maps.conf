# ==============================
# Method discipline
# ==============================
map $request_method $bad_method {
    default 1;
    GET     0;
    HEAD    0;
    POST    0;
    PUT     0;  # Add if you use REST APIs
    PATCH   0;  # Add if you use REST APIs
    DELETE  0;  # Add if you use REST APIs
    OPTIONS 0;  # Needed for CORS preflight
}

# ==============================
# POST allowed only on known prefixes
# ==============================
map "$request_method:$uri" $bad_post_target {
    default 0;
    "~^POST:/(?!api/|oauth/|graphql|webhook/|auth/|login|contact|search)" 1;
}

# ==============================
# Host sanity
# ==============================
map $host $bad_host {
    default 0;
    "" 1;
    "~^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$" 1;
    "~^[0-9a-f:]+$" 1;  # IPv6 addresses
    "localhost" 1;       # Add if not serving on localhost
}

# ==============================
# Path traversal & encoding abuse
# ==============================
map $request_uri $bad_uri {
    default 0;
    # Path traversal
    "~*(\\.\\.|%2e|%252e)" 1;
    # Null bytes and encoding abuse  
    "~*(%00|%0d|%0a|%5c|%ad)" 1;
    # Hex/octal encoding attempts (simpler pattern)
    "~*(\\\\x|0x[0-9a-f])" 1;
    # Sensitive files
    "~(/\\.env|/\\.git|/\\.aws|/\\.docker|\\.bak$|\\.sql$|\\.zip$|\\.tar\\.gz$)" 1;
    # Path anomalies
    "~(//|/\\./)" 1;
}

# ==============================
# Exploit-style query strings
# ==============================
map $query_string $bad_query {
    default 0;
    "~(php://|data://|expect://|auto_prepend_file|allow_url_include)" 1;
    "~(invokefunction|call_user_func|eval\(|assert\()" 1;
    "~(base64_decode|gzinflate|str_rot13)" 1;
    "~(<script|javascript:|onerror=|onload=)" 1;
    "~(union.*select|concat.*\(|@@version)" 1;  # SQL injection
    "~(\.\./\.\./|boot\.ini|etc/passwd|win\.ini)" 1;
}

# ==============================
# Scanner-ish User-Agents
# ==============================
map $http_user_agent $bad_ua {
    default 0;
    "" 1;
    "-" 1;
    # Scanners & security tools
    "~*(curl|wget|python-requests|go-http-client)" 1;
    "~*(masscan|nmap|zgrab|nuclei|acunetix|sqlmap|nikto)" 1;
    "~*(nessus|openvas|metasploit|burp|zap)" 1;
    # Scrapers
    "~*(scrapy|beautifulsoup|mechanize|httpx)" 1;
    # Generic bots (be careful - some are legitimate)
    "~*(bot|crawler|spider|scraper|slurp)" 1;
    # Common attack tools
    "~*(havij|zmeu|dirbuster|gobuster|wpscan)" 1;
}

# ==============================
# Suspicious headers
# ==============================
map $http_x_forwarded_for $bad_xff {
    default 0;
    "~[,;]" 1;  # Multiple IPs or suspicious delimiters
}

map $http_referer $bad_referer {
    default 0;
    "~*(viagra|cialis|casino|porn|xxx)" 1;
    "~*(semalt\.com|buttons-for-website\.com)" 1;  # Known spam domains
}

# ==============================
# File extension blocking
# ==============================
map $request_uri $bad_extension {
    default 0;
    "~*\.(asp|aspx|php[0-9]?|jsp|cgi)$" 1;  # Only if you don't use these
    "~*\.(exe|dll|bat|sh|pl)$" 1;
}

# ==============================
# Suspicious request patterns
# ==============================
map $request_uri $wordpress_probe {
    default 0;
    "~*(wp-admin|wp-login|wp-content|xmlrpc\.php)" 1;  # If not using WordPress
}

map $request_uri $known_vuln_paths {
    default 0;
    "~*(/admin|/phpmyadmin|/adminer|/manager/html)" 1;  # Adjust based on your setup
    "~*(/solr/|/jenkins/|/actuator/)" 1;
    "~*(\.php\.|\.asp\.|\.aspx\.)" 1;  # Double extensions
}